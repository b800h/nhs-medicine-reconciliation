{% extends "base.html" %}
{% load staticfiles %}

{% block extra_css %}
  <link href="{% static 'css/medicine_reconcile.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block content %}
<h1>{% block title %}Medication Reconcilation{%endblock title %}</h1>

<div class="row show-for-portrait">
  <div class="medium-8 medium-centered columns">
    <div data-alert class="alert-box secondary radius please-rotate">
      Please rotate your device to landscape mode.
    </div>
  </div>
</div>

<div class="row med-rec-container show-for-landscape">
  {% include "reconcile_medicine_header.html" with title="GP" source="gp" %}
  {% include "reconcile_medicine_header.html" with title="Medication History" source="history" %}
  {% include "reconcile_medicine_header.html" with title="In Patient Prescription" source="inpatient" %}
  {% include "reconcile_medicine_header.html" with title="Reconciled Medications" source="reconcile" %}
</div>

{% for medication in medications %}
<div class="row med-rec-container show-for-landscape">
  {% include "reconcile_medicine_medication_tile.html" with medication=medication.gp source="gp" %}
  {% include "reconcile_medicine_medication_tile.html" with medication=medication.history source="gp" %}

  <div class="medium-3 columns med-rec-col">
    <div class="med-rec-source">
      <div></div>
    </div>
  </div>
  <div class="medium-3 columns med-rec-col">
    <div class="med-rec-target">
      <div class="dropzone" data-med-id="{{ medication.medinfo.vpid }}" data-med-nm="{{ medication.medinfo.nm }}">
        <span class="dropzone-text"></span>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock content %}

{% block extra_js %}
  <script type="text/javascript" src="{% static 'js/foundation/foundation.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/foundation/foundation.equalizer.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/jquery-ui.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/jquery.ui.touch-punch.min.js' %}"></script>


  <script type="text/javascript">
    $(document).foundation();

    $(function() {
      $('.med-tile').draggable({
        revert: "invalid",
        revertDuration: 200,
        helper: function() {
          var helper = $(this).clone()
          helper.attr('data-helper', '');
          return helper;
        },
        start: function(event, ui) {
          ui.helper.css('z-index', 99999);
          ui.helper.addClass('drag-helper');
          var med_id = ui.helper.attr('data-med-id');

          $('.med-tile[data-med-id="' + med_id + '"]').not('[data-helper]').each(function() {
            $(this).addClass('in-progress');
          });

          $('.dropzone').each(function() {
            if ($(this).attr('data-med-id') === med_id) {
              $(this).find('.dropzone-text').html('Continue as Prescribed');
              $(this).removeClass('replace');
              $(this).addClass('continue');
              $(this).attr('data-operation', 'continue');
            } else {
              $(this).find('.dropzone-text').html('Replace ' + $(this).attr('data-med-nm'));
              $(this).removeClass('continue');
              $(this).addClass('replace');
              $(this).attr('data-operation', 'replace');
            }
            $(this).addClass('visible');
          });
        },
        stop: function(event, ui) {
          ui.helper.removeClass('drag-helper');
          var med_id = ui.helper.attr('data-med-id');

          $('.med-tile[data-med-id="' + med_id + '"]').not('[data-helper]').each(function() {
            $(this).removeClass('in-progress');
          });

          $('.dropzone').removeClass('visible');
        }
      });

      $(".dropzone").droppable({
        hoverClass: "ui-state-hover",
        drop: function(event, ui) {
          var med_id = ui.helper.attr('data-med-id');

          $('.med-tile[data-med-id="' + med_id + '"]').not('[data-helper]').each(function() {
            $(this).draggable("destroy");
            $(this).addClass('complete');
          });

          if ($(this).attr('data-operation') === 'continue') {
            $(this).replaceWith(ui.draggable.clone());
          } else if ($(this).attr('data-operation') === 'replace') {
            //$(this).parent().append(ui.draggable.clone());
            $(this).replaceWith(ui.draggable.clone());
          }
          
          ui.helper.remove();

          $('.dropzone').removeClass('visible');
        },
        // activate: function(event, ui) {
          

        //   // $('#drop-helper').show(300, 'linear');
        // },
        // deactivate: function(event, ui) {
        //   $('#drop-helper').hide(300);
        // }
      });
    });
  </script>


{% endblock extra_js %}